---
title: "Figure 2"
output: html_document
---
<style type="text/css">
body{ /* Normal  */
      font-size: 10px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 24px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 16px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 16px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 12px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 10px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 10px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE, cache.lazy = FALSE, fig.path="./graphics/plot",autodep=TRUE)
library(ggplot2)
library(cowplot)
library(caTools)
library(reshape2)
library(dplyr)
library(gridGraphics)
library(RColorBrewer)
```


## Reading in GLM regression results
```{r}
# remove NA's (from insufficient data for regression)
regNA = na.omit(read.table(gzfile("../results/mel_all_paired20_2sample_caF_popyear.f_s.glm.gz"), header=T, stringsAsFactors = F))
filterpoly = read.table(gzfile("../data/chrom_pos_polymorphic_medfreq01_RRgrt0.txt.gz"), stringsAsFactors=F)
reg = merge(regNA, filterpoly, by=c(1,2))
```


# GLM % of snps at permutations quantile = 0.01
```{r}
q01 = quantile(reg$seas.p, probs=0.01)
q01 #0.003894319
neglogq01 = -log10(q01) #2.409568

glm_q01 = read.table(file=paste( "../results/perm500_pvalue_of_quant01.txt", sep=""), stringsAsFactors = F)
glm_q01_df = data.frame(dataset="perm", pvalue=glm_q01[,1])
mean(glm_q01_df$pvalue<q01) #0.032
# obs greater than 0.968

plot.labels = data.frame(x=c(2.45,2.45), y=c(2.45,2.35), labels=c("3.2% perms.","96.8% perms."))
q01_pvalue =
  ggplot(glm_q01_df )+
  geom_jitter(aes(x=1,y=-log10(pvalue)), width = 0.5, cex=0.8, alpha=0.2, col="black")+
  geom_segment(aes(x=0.3, y=neglogq01, xend = 3, yend=neglogq01), lty=3, col="red")+
  geom_text(data=plot.labels, aes(x=x, y=y, label=labels), size=2.5)+
  geom_label(data=plot.labels, aes(x=2.4, y=neglogq01, label="observed"), size=2.5, fill="white", col="red")+
  geom_point(aes(x=1,y=neglogq01), alpha=0.2, col="red", fill="black", size=2, shape=21)+
  ggtitle("GLM (-log(p-value))")+
  xlab("")+
  ylab("Seasonal test statistic at Quant=0.01")+
  theme_cowplot()+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 12)),   
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        plot.title = element_text(size = 8))
```


## RFM: load in data
```{r}
# load(file="/Users/hm8/stanford/nescent_melCA/fishers_method_Oct2016/jamie_fisher_method/permutations/pop20_polymorphic_permutations_June2020.permL_both.Rdata")
# #obs.L.both
# load(file="/Users/hm8/stanford/nescent_melCA/fishers_method_Oct2016/jamie_fisher_method/permutations/pop20_polymorphic_June2020.obsL_both.Rdata")

#### FILE TOO BIG- must reduce size to only what I'll use. See original script
#perm.L.both
#load(file="../results/pop20_polymorphic_permutations_June2020.permL_both.Rdata")
#obs.L.both
#load(file="../results/pop20_polymorphic_June2020.obsL_both.Rdata")

# rfm01obs = quantile(obs.L.both, probs=0.99)
# rfm01obs #32.02457 
# rfm01permX = data.frame(top01=as.numeric(lapply(perm.L.both[1:200], FUN=function(X) quantile(X, probs=0.99))) )
# mean(rfm01permX>=rfm01obs) # 0.02
# save(rfm01obs, rfm01permX, file="rfm01obs_rfm01permX_figureobjects.Rdata")
load(file="rfm01obs_rfm01permX_figureobjects.Rdata")
```


## RFM X2 (quant 0.01)
```{r}
plot.labels_p = data.frame(x=c(2.5,2.5), y=c(32.08,31.95), labels=c("2% perms.","98% perms."))
q01_rfm_x = 
ggplot(rfm01permX)+
  geom_jitter(aes(x=1,y=top01), width = 0.5, cex=0.8, alpha=0.2, col="black")+
  geom_segment(aes(x=0.3, y=rfm01obs, xend = 3, yend=rfm01obs), lty=3, col="red")+
  geom_text(data=plot.labels_p, aes(x=x, y=y, label=labels), size=2.5)+
  geom_point(aes(x=1,y=rfm01obs), alpha=0.2, col="red", fill="black", size=2, shape=21)+
  geom_label(aes(x=2.4, y=rfm01obs, label="observed"), size=2.5, fill="white", col="red")+
  ylab("")+
  theme_light()+
  xlab("")+
  ggtitle("RFM (X2)")+
  theme_cowplot()+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        plot.title = element_text(size = 8))
```

## Bayenv: load in data
```{r}
bayes_sortedDF = read.table(file=gzfile("../results/bayes_sortedDF.full_100perms_polymorphic_sorted.txt.gz"), header=T, stringsAsFactors = F) # 749109
```


## bayes factor at 0.01 for each permutation 
```{r}
bayenv01 = apply(bayes_sortedDF, MARGIN=2, FUN=quantile, probs=0.99)
bayenv01perm = data.frame(top01=bayenv01[1:100])
bayenv01obs = bayenv01[101] # 2.639992
mean(bayenv01obs>bayenv01perm) #0.94

plot.labels_p = data.frame(x=c(2.45,2.45), y=c(3.2,2), labels=c("6% perms.","94% perms."))
# 1 outlier permutation at 10.25292 (omit)
q01_bayenv =
ggplot(subset(bayenv01perm, top01 != max(bayenv01perm$top01)) )+
  geom_jitter(aes(x=1,y=top01), width = 0.5, cex=0.8, alpha=0.2, col="black")+
  geom_segment(aes(x=0.3, y=bayenv01obs, xend = 3, yend=bayenv01obs), lty=3, col="red")+
  geom_text(data=plot.labels_p, aes(x=x, y=y, label=labels), size=2.5)+
  geom_point(aes(x=1,y=bayenv01obs), alpha=0.2, col="red", fill="black", size=2, shape=21)+
  geom_label(aes(x=2.4, y=bayenv01obs, label="observed"), size=2.5, fill="white", col="red")+
  ylab("")+
  theme_cowplot()+
  xlab("")+
  ggtitle("Bayenv (Bayes factor)")+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        plot.title = element_text(size = 8))
```


## GLM pvalue histogram
```{r}
make_bins = function(x, size){
  x = na.omit(x)
  my_seq = seq(from=0, to=1, by=size)
  my_sum=vector()
  for (i in 1:(length(my_seq)-1) ){
    my_sum[i] = sum(x>=my_seq[i] & x<my_seq[i+1])
  }
  list(my_sum, my_seq)
}
  
mybins = make_bins(reg[,4], 0.001)
trimmed = mybins[[1]][1:(length(mybins[[1]])-1)]

perms = read.table("../results/permutation_prop_by_bin001_perm500.txt", header=TRUE)
perms_trim = perms[,1:(ncol(perms)-1)]
perms_trim2 = t(apply(perms_trim, MARGIN=1, FUN=function(X) X/sum(X)))
perms_trim2_med = apply(perms_trim2, MARGIN=2, FUN=median)
q01 = quantile(reg[,4], probs=0.01)

glm_df = data.frame(pvalue=mybins[[2]][2:(length(mybins[[2]])-1)], prop=trimmed/sum(trimmed))
perm_df = data.frame(pvalue=mybins[[2]][2:(length(mybins[[2]])-1)], prop=t(perms_trim2) )
perm_df2 = melt(perm_df, id="pvalue")
colnames(perm_df2) = c("pvalue","perm","prop")
Nsnps = nrow(reg) # 774655

# Cannot plot all bins, so sample higher p-value bins sparsely
pvalue_subset_inds = c(1:25, round((1:100)^2)[1:31]+26,999)

# Cannot plot all 500 permutations, so take a subset
perm_df_subset = perm_df[ ,c(1,sample(1:500, size=49)+1,96) ]
perm_df2_subset = melt(perm_df_subset[pvalue_subset_inds,], id="pvalue")
colnames(perm_df2_subset) = c("pvalue","perm","prop")

glm_hist = 
  ggplot(perm_df2_subset, aes(pvalue, prop*Nsnps)) +
  geom_line(aes(group=perm), color="black", alpha=0.2) +
  geom_line(data=glm_df, aes(pvalue, prop*Nsnps), color="red", size=0.8, alpha=1) +
  geom_point(data=glm_df, aes(pvalue, prop*Nsnps), color="red", size=1, alpha=1) +
  scale_x_continuous(trans="log10", breaks=c(10^c(-3, -2, -1, 0), expand.grid(sapply(c(1:9), function(x) x*10^c(-3, -2, -1))) [,1]), labels=c(0.001, .01, .1, 1, rep("", length(expand.grid(sapply(c(1:9), function(x) x*10^c(-3, -2, -1)))[,1])) ) ) + 
  geom_hline(yintercept=0.001*Nsnps, lty=2) +
  xlab("Seasonal P-value") + 
  ylab("# SNPs per bin") + 
  geom_vline(xintercept = q01, col="red",lty=3)+
  geom_text(aes(x=c(0.0021), y=c(1000)), label=c("Quant=0.01 \n    P=0.004"), size=2.5, fontface="plain") +
  theme_cowplot()+
  theme(legend.direction="vertical", 
        panel.grid.minor = element_blank(),
        legend.justification=c("right"), 
        legend.position=c(1,0.5), 
        legend.key.size = unit(0.35, "cm"),
        legend.background=element_rect(fill="white", colour="white", linetype="solid", size=.25),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
        legend.title.align=.5,
        axis.text=element_text(size=8),
        axis.title=element_text(size=10))                     
```




## AF delta
```{r}
# glm_AF_scatter
#save(glm_df_orig,glm2FM_samp_orig, file="/Users/hm8/nescent_melCA/significant_snps/ggplot_glmsig_deltaAF.Rdata")
load(file="../results/ggplot_glmsig_deltaAF.Rdata")

afdelta_plot = 
  ggplot(glm2FM_samp_orig) + 
  geom_point(aes(Smean_fold, abs(meanf_s), color=seas), pch=20, alpha=0.1) +
  geom_smooth(aes(Smean_fold, abs(meanf_s), color=seas)) + 
  scale_color_manual("", values=c("Non-seasonal"="black","Seasonal (Quant=0.01)"="red") ) +
  ylim(c(0,0.15)) + 
  ylab(expression(paste("Spring/fall ",Delta,"AF (abs)"))) +
  xlab("Spring AF") +
  theme_cowplot()+
  theme(
        legend.direction="vertical",
        legend.justification=c("left"),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        legend.position=c(0.15,0.9),
        legend.key.size = unit(0.35, "cm"),
        legend.background=element_rect(fill=FALSE, colour="white", linetype="solid", size=.25),
        legend.title.align=0,
        legend.margin=margin(0,0,0,0),
        axis.text=element_text(size=8),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),
        axis.title=element_text(size=10),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())  

```


## clinal
```{r}
load("../results/figure_objects_Jan2018.Rdata")
load("../results/clinal_uniquepopsPAnoMA_parallelism_vs_controlsDec2017_quant_polymorphic_ext.Rdata")
myquant = subset(df2, pops=="CA")[nrow(subset(df2, pops=="CA")):1,c("quant")][4:24]
myquant = c(rev(10^(-(seq(from=0, to=2, by=0.25)))))
all_quantN = all_concordN = vector()
quantseas = quantile(allcoef$seas.p, probs=c(0,myquant) )
quantclin = quantile(allcoef[,6], probs=c(0,myquant) )
for (i in 1:(length(myquant))){
  quantboth = na.omit(allcoef[allcoef$seas.p< quantseas[i+1] & allcoef[,6]<quantclin[i+1] & allcoef$seas.p>=quantseas[i] & allcoef[,6]>=quantclin[i], ])
  all_quantN[i] = nrow(quantboth)
  all_concordN[i] = sum( (quantboth[,3]>=0 & quantboth[,5]>=0) | (quantboth[,3]<0 & quantboth[,5]<0) )
}
all_quant_df = data.frame(quant = myquant, N=all_quantN, Nconcord = all_concordN, Pconcord =all_concordN/all_quantN, dataset="ALL" )

load("../results/clinal_uniquepopsPAnoMA_CAparallelism_vs_controlsDec2017_quant_polymorphic_ext.Rdata")
ca_quantN = ca_concordN = vector()
quantseas = quantile(allcoef$seas.p, probs=c(0,myquant) )
quantclin = quantile(allcoef[,6], probs=c(0,myquant) )
for (i in 1:(length(myquant))){
  quantboth = na.omit(allcoef[allcoef$seas.p< quantseas[i+1] & allcoef[,6]<quantclin[i+1] & allcoef$seas.p>=quantseas[i] & allcoef[,6]>=quantclin[i], ])
  ca_quantN[i] = nrow(quantboth)
  ca_concordN[i] = sum( (quantboth[,3]>=0 & quantboth[,5]>=0) | (quantboth[,3]<0 & quantboth[,5]<0) )
}
ca_quant_df = data.frame(quant = myquant, N=ca_quantN, Nconcord = ca_concordN, Pconcord =ca_concordN/ca_quantN, dataset="CA")

load("../results/clinal_uniquepopsPAnoMA_EUparallelism_vs_controlsDec2017_quant_polymorphic_ext.Rdata")
eu_quantN = eu_concordN = vector()
quantseas = quantile(allcoef$seas.p, probs=c(0,myquant) )
quantclin = quantile(allcoef[,6], probs=c(0,myquant) )
for (i in 1:(length(myquant))){
  quantboth = na.omit(allcoef[allcoef$seas.p< quantseas[i+1] & allcoef[,6]<quantclin[i+1] & allcoef$seas.p>=quantseas[i] & allcoef[,6]>=quantclin[i], ])
  eu_quantN[i] = nrow(quantboth)
  eu_concordN[i] = sum( (quantboth[,3]>=0 & quantboth[,5]>=0) | (quantboth[,3]<0 & quantboth[,5]<0) )
}
eu_quant_df = data.frame(quant = myquant, N=eu_quantN, Nconcord = eu_concordN, Pconcord =eu_concordN/eu_quantN, dataset="EU" )
df_noncum = rbind(all_quant_df, ca_quant_df, eu_quant_df)

clinalplot = 
  ggplot(data=df2, aes(quant, concord, group=pops) ) +
    scale_x_continuous(trans="log10", 
        breaks=c(10^c(-2, -1, 0), expand.grid(sapply(c(1:9), function(x) x*10^c(-3, -2, -1))) [,1]), 
        labels=c(.01, .1, 1, rep("", length(expand.grid(sapply(c(1:9), function(x) x*10^c(-3, -2, -1)))[,1])) ) ) + 
  geom_hline(yintercept = 0.5, lty=2) +
  geom_polygon(data=nCA, mapping=aes(x=x, y=y, group=NULL, fill=NULL), fill="purple", alpha=0.8) +
  geom_polygon(data=nEU, mapping=aes(x=x, y=y, group=NULL, fill=NULL), fill="light green", alpha=0.5) +
  geom_line(aes(quant, concord)) + 
  geom_point(aes(quant, concord, fill=pops, size=pops), color="black", shape=21) + 
  scale_fill_manual(name='', values=c("ALL"="black","CA"="purple","EU"="light green") ) +
  scale_alpha_manual(name='', values=c("ALL"=1,"CA"=0.7,"EU"=0.2) ) +
  scale_size_manual(name='', values=c("ALL"=2,"CA"=2,"EU"=2) ) +
  ylab("Concordance") + 
  xlab("Seasonal/latitudinal quantile") +
  theme_cowplot()+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.direction="vertical", 
        legend.justification=c("right"), 
        legend.position=c(1,0.25), 
        legend.key.size = unit(0.35, "cm"),
        legend.background=element_rect(fill=FALSE, colour="white", linetype="solid", size=.25),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        legend.title.align=.5,  
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 12)),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10) )
```


## clinal concordance by inversions
```{r}
concordDF = read.table("../results/concordDF_Jan2021.txt", header=T, stringsAsFactors = F, sep="\t")
concordDF$class = factor(concordDF$class, levels=c( "all", "bkpts", "interior", "exterior"))

concord_inv = 
  ggplot(subset(concordDF, jointquantile==0.05 & !(inv %in% c("In(3R)K",    "In(3R)Mo",    "In(3R)P")) ), aes(x=chrom, weight=concord, ymin=concord-1.96*se, ymax=concord+1.96*se, fill=class)) +
    geom_bar(position=position_dodge(), aes(y=concord), stat="identity") +
    geom_errorbar(position=position_dodge(width=0.9), colour="grey", width=0.5) +
    geom_hline(yintercept=0.5, linetype="dashed")+
    geom_text    (position=position_dodge(width=0.9), aes(y=0.02, label=pvaluelabel), size=6)+
    scale_fill_brewer("Region", labels=c("all","bkpts.","inside","outside"), palette = "Set2")+
    theme_cowplot()+
    ylab("Concordance")+
    xlab("Chromosome")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 12)),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10))
```

## seasonal enrichment by inversions
```{r}
chr_inv = read.table(file="../results/chr_inv_enrichment_pvalues_Jan2021.txt", header=T, stringsAsFactors = F, sep="\t")
chr_inv$class = factor(chr_inv$class, levels = c( "all", "bkpts", "interior", "exterior") )

enrich_inv = 
  ggplot(subset(chr_inv, pvalue==0.003894319 & !(inv %in% c("In(3R)K",    "In(3R)Mo",    "In(3R)P")) ), aes(x=chrom, weight=median_enrich, ymin=lower95_enrich, ymax=upper95_enrich, fill=class)) +
  geom_bar      (position=position_dodge(), aes(y=median_enrich), stat="identity") +
  geom_errorbar (position=position_dodge(width=0.9), colour="grey", width=0.5) +
  geom_text    (position=position_dodge(width=0.9), aes(y=0.05, label=sig_lower90), size=6)+
  geom_hline(yintercept=1, linetype="dashed")+
  scale_fill_brewer("Region", labels=c("all","bkpts.","inside","outside"), palette = "Set2")+
  theme_cowplot()+
  ylab("Seasonal enrichment")+ # (# SNPs obs/perm)
  xlab("Chromosome")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 12)),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10))
```


## all plots
```{r}
toprow2 = plot_grid(glm_hist, NULL, q01_pvalue + theme(plot.margin = unit(c(5.5, 0, 20, 4), "points")), q01_bayenv + theme(plot.margin = unit(c(5.5, 0, 20, 0), "points")), q01_rfm_x + theme(plot.margin = unit(c(5.5, 4, 20, 0), "points")),
                          labels = c('A', "", 'B'),
                          nrow=1, vjust=1.5, scale = c(1,1,1,1,1), rel_widths = c(0.45, 0.05, c(0.2, 0.175, 0.195)/1.14) )

middlerow2 = plot_grid(afdelta_plot, NULL, enrich_inv,
                        labels = c("C", "","D"),
                          nrow=1, vjust=1.5, scale = 1, rel_widths = c(0.45, 0.05, 0.5) )

bottomrow2 = plot_grid(clinalplot, NULL, concord_inv,
                          labels = c("E","","F"),
                          nrow=1, vjust=1.5, scale = 1, rel_widths = c(0.45, 0.05, 0.5) )
multiPlot =
  plot_grid(toprow2,NULL, middlerow2,NULL, bottomrow2, nrow = 5, vjust=1.5, rel_heights = c(1, 0.2, 1, 0.2, 1))

save_plot(multiPlot, file="Fig2.pdf", base_height=11, base_width = 11)
multiPlot
```

