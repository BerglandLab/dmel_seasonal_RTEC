---
title: "analysis_season_glm_polymorphic Nov 2020: Figure 2"
output: html_document
---
<style type="text/css">
body{ /* Normal  */
      font-size: 10px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 24px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 16px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 16px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 12px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 10px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 10px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE, cache.lazy = FALSE, fig.path="./graphics/plot",autodep=TRUE)
knitr::opts_knit$set(root.dir = '/Users/hm8/stanford/nescent_melCA/seasonal2020')
library(ggplot2)
library(cowplot)
library(caTools)
library(reshape2)
library(dplyr)
library(gridGraphics)
library(RColorBrewer)
```


## Reading in regression results
```{r}
regNA = na.omit(read.table("/Users/hm8/stanford/nescent_melCA/glm/mel_all_paired20_2sample_caF_popyear.f_s.glm", header=T, stringsAsFactors = F))
filterpoly = read.table("/Users/hm8/stanford/nescent_melCA/data/chrom_pos_polymorphic_medfreq01_RRgrt0.txt", stringsAsFactors=F)
reg = merge(regNA, filterpoly, by=c(1,2))
```


# number of snps at quantile = 0.01 (top 1% = p<0.00389) (full vs permutation)
```{r}
q01 = quantile(reg$seas.p, probs=0.01)
quantile(reg$seas.p, probs=0.01) #0.003894319

glm_q01_enrich = read.table(file="/Users/hm8/stanford/nescent_melCA/glm_permutations/perm500_n_less_p00389.txt", stringsAsFactors = F)
glm_q01_enrich_df = data.frame(dataset="glm", enrich=glm_q01_enrich[,1])
glm_q01_enrich_df$grtobs = FALSE
glm_q01_enrich_df$grtobs[glm_q01_enrich_df$enrich > sum(reg[,4]<q01)] = TRUE

glm_full_q01 = data.frame(q01 = sum(reg[,4]<q01), dataset="full")
mean(glm_q01_enrich<sum(reg[,4]<q01))
# obs greater than 0.968
plot.labels = data.frame(x=c(2.5,2.5), y=c(8200,7000), labels=c("3.2% perms.","96.8% perms."))
glmQ01N = as.numeric(glm_full_q01[1])

# 
# q01_enrich = 
#   ggplot(glm_q01_enrich_df, aes(y=enrich, x=1) )+
#   geom_jitter(aes(x=1,y=enrich), width = 0.5, cex=0.8, alpha=0.2, col="black")+
#   geom_segment(aes(x=0.3, y=as.numeric(glm_full_q01[1]), xend = 3, yend=as.numeric(glm_full_q01[1])), lty=3, col="red")+
#   geom_text(data=plot.labels, aes(x=x, y=y, label=labels), size=2.7)+
#   ylab("# SNPs P<0.004")+
#   xlab("")+
#   theme_cowplot()+
#   scale_x_discrete(limits=c(1,3))+
#   theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(), 
#         axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank(),
#         axis.text=element_text(size=8),
#         axis.title=element_text(size=10))
```

# enrichment of snps at quantile = 0.01 (top 1% = p<0.00389) (full vs permutation)
```{r}
# glm_q01_enrich_df_p = glm_q01_enrich_df
# glm_q01_enrich_df_p$enrich = glm_q01_enrich_df$enrich/nrow(reg)
# plot.labels_p = data.frame(x=c(2.5,2.5), y=c(1.05,0.89), labels=c("3.2% perms.","96.8% perms."))

# q01_enrich_p = 
#   ggplot(glm_q01_enrich_df_p, aes(y=enrich*100, x=1) )+
#   geom_jitter(aes(x=1,y=enrich*100), width = 0.5, cex=0.8, alpha=0.2, col="black")+
#   geom_segment(aes(x=0.3, y=1, xend = 3, yend=1), lty=3, col="red")+
#   geom_text(data=plot.labels_p, aes(x=x, y=y, label=labels), size=2.7)+
#   #ylab("% SNPs P<0.004")+
#   ylab("% SNPs > Obs Quant=0.01")+
#   xlab("")+
#   ggtitle("GLM")+
#   theme_cowplot()+
#   #scale_y_continuous(limits=c(0,3))+
#   theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(), 
#         axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank(),
#         axis.text=element_text(size=8),
#         axis.title=element_text(size=10))
```

# % of snps at permutations quantile = 0.01
```{r}
q01 = quantile(reg$seas.p, probs=0.01)
q01 #0.003894319
neglogq01 = -log10(q01) #2.409568

glm_q01 = read.table(file=paste( "/Users/hm8/volumes/hm8_network/nescent_melCA/glm_permutations/perm500_pvalue_of_quant01.txt", sep=""), stringsAsFactors = F)
glm_q01_df = data.frame(dataset="perm", pvalue=glm_q01[,1])
mean(glm_q01_df$pvalue<q01) #0.032
# obs greater than 0.968

plot.labels = data.frame(x=c(2.45,2.45), y=c(2.45,2.35), labels=c("3.2% perms.","96.8% perms."))
q01_pvalue =
  ggplot(glm_q01_df )+
  geom_jitter(aes(x=1,y=-log10(pvalue)), width = 0.5, cex=0.8, alpha=0.2, col="black")+
  geom_segment(aes(x=0.3, y=neglogq01, xend = 3, yend=neglogq01), lty=3, col="red")+
  geom_text(data=plot.labels, aes(x=x, y=y, label=labels), size=2.5)+
  geom_label(data=plot.labels, aes(x=2.4, y=neglogq01, label="observed"), size=2.5, fill="white", col="red")+
  geom_point(aes(x=1,y=neglogq01), alpha=0.2, col="red", fill="black", size=2, shape=21)+
  ggtitle("GLM (-log(p-value))")+
  xlab("")+
  ylab("Seasonal test statistic at Quant=0.01")+
  theme_cowplot()+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 12)),   
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        plot.title = element_text(size = 8))

```


## RFM
```{r}
#perm.L.both
load(file="/Users/hm8/stanford/nescent_melCA/fishers_method_Oct2016/jamie_fisher_method/permutations/pop20_polymorphic_permutations_June2020.permL_both.Rdata")
#obs.L.both
load(file="/Users/hm8/stanford/nescent_melCA/fishers_method_Oct2016/jamie_fisher_method/permutations/pop20_polymorphic_June2020.obsL_both.Rdata")

rfm01obs = quantile(obs.L.both, probs=0.99)
rfm01obsN = sum(obs.L.both > rfm01obs)/2  # 4704
rfm01permN = data.frame(top01sum=as.numeric(lapply(perm.L.both[1:200], FUN=function(X) sum(X>rfm01obs))) )
mean(rfm01permN>rfm01obsN) # 0.025

plot.labels = data.frame(x=c(2.5,2.5), y=c(4800,4500), labels=c("2.5% perms.","97.5% perms."))

# q01_enrich_rfm = 
# ggplot(rfm01permN)+
#   geom_jitter(aes(x=1,y=top01sum), width = 0.5, cex=0.8, alpha=0.2, col="black")+
#   geom_segment(aes(x=0.3, y=rfm01obsN, xend = 3, yend=rfm01obsN), lty=3, col="red")+
#   geom_text(data=plot.labels, aes(x=x, y=y, label=labels), size=2.7)+
#   ylab("# SNPs X2 > 32")+
#   theme_light()+
#   xlab("")+
#   #scale_x_discrete(limits=c(1,3))+
#   theme_cowplot()+
#   theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(), 
#         axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank(),
#         axis.text=element_text(size=8),
#         axis.title=element_text(size=10))

```

## RFM percent
```{r}
rfm01permN_p = rfm01permN
rfm01permN_p$top01sum = rfm01permN$top01sum/length(perm.L.both[1][[1]])
plot.labels_p = data.frame(x=c(2.5,2.5), y=c(1.02,0.94), labels=c("2.5% perms.","97.5% perms."))

# q01_enrich_rfm_p = 
# ggplot(rfm01permN_p)+
#   geom_jitter(aes(x=1,y=as.numeric(top01sum)*100), width = 0.5, cex=0.8, alpha=0.2, col="black")+
#   geom_segment(aes(x=0.3, y=1, xend = 3, yend=1), lty=3, col="red")+
#   geom_text(data=plot.labels_p, aes(x=x, y=y, label=labels), size=2.7)+
#   #ylab("% SNPs X2 > 32")+
#   ylab("")+
#   theme_light()+
#   #xlab("RFM")+
#   xlab("")+
#   ggtitle("RFM")+
#   #scale_y_continuous(limits=c(0,3))+
#   theme_cowplot()+
#   theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(), 
#         axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank(),
#         axis.text=element_text(size=8),
#         axis.title=element_text(size=10))

```

## RFM X2 (quant 0.01)
```{r}
rfm01obs #32.02457 
rfm01permX = data.frame(top01=as.numeric(lapply(perm.L.both[1:200], FUN=function(X) quantile(X, probs=0.99))) )
mean(rfm01permX>=rfm01obs) # 0.02
#plot.labels_p = data.frame(x=c(2.5,2.5), y=c(35,30), labels=c("2.5% perms.","97.5% perms."))

plot.labels_p = data.frame(x=c(2.5,2.5), y=c(32.08,31.95), labels=c("2% perms.","98% perms."))
q01_rfm_x = 
ggplot(rfm01permX)+
  geom_jitter(aes(x=1,y=top01), width = 0.5, cex=0.8, alpha=0.2, col="black")+
  geom_segment(aes(x=0.3, y=rfm01obs, xend = 3, yend=rfm01obs), lty=3, col="red")+
  geom_text(data=plot.labels_p, aes(x=x, y=y, label=labels), size=2.5)+
  geom_point(aes(x=1,y=rfm01obs), alpha=0.2, col="red", fill="black", size=2, shape=21)+
  geom_label(aes(x=2.4, y=rfm01obs, label="observed"), size=2.5, fill="white", col="red")+
  #ylab("% SNPs X2 > 32")+
  ylab("")+
  theme_light()+
  #xlab("RFM")+
  xlab("")+
  ggtitle("RFM (X2)")+
  #scale_y_continuous(limits=c(0,3))+
  theme_cowplot()+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        plot.title = element_text(size = 8))

```

## Enrichment of bayes factor over permutation 
```{r}
nperm = 100
bayes_sortedDF = read.table(file="/Users/hm8/stanford/nescent_melCA/seasonal2020/bayenv/bayes_sortedDF.full_100perms_polymorphic_sorted.txt", header=T, stringsAsFactors = F) # 749109
top01 = bayes_sortedDF[round(nrow(bayes_sortedDF)*0.01),]
top01full = top01$full #top01$full
mean(top01$full > top01[1:nperm]) #0.94
bayenv01sum = data.frame(top01sum = apply(bayes_sortedDF, MARGIN=2, FUN=function(X) sum(X>top01full))[1:100] )
plot.labels = data.frame(x=c(2.5,2.5), y=c(10000,4000), labels=c("6% perms.","94% perms."))

# q01_enrich_bayenv = 
#   ggplot(bayenv01sum)+
#   geom_jitter(aes(x=1,y=top01sum), width = 0.5, cex=0.8, alpha=0.2, col="black")+
#   geom_segment(aes(x=0.3, y=7491, xend = 3, yend=7491), lty=3, col="red")+
#   geom_text(data=plot.labels, aes(x=x, y=y, label=labels), size=2.7)+
#   ylab("# SNPs Bayes Factor > 2.6")+
#   theme_cowplot()+
#   xlab("")+
#   #scale_x_discrete(limits=c(1,3))+
#   theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(), 
#         axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank(),
#         axis.text=element_text(size=8),
#         axis.title=element_text(size=10),
#         plot.title = element_text(size = 8))
```

## % bayes factor over permutation 
```{r}
# bayenv01sum_p = bayenv01sum
# bayenv01sum_p$top01sum = bayenv01sum$top01sum/nrow(bayes_sortedDF)
# plot.labels_p = data.frame(x=c(2.5,2.5), y=c(1.5,0.5), labels=c("6% perms.","94% perms."))

# q01_enrich_bayenv_p = 
# ggplot(bayenv01sum_p)+
#   geom_jitter(aes(x=1,y=top01sum*100), width = 0.5, cex=0.8, alpha=0.2, col="black")+
#   geom_segment(aes(x=0.3, y=1, xend = 3, yend=1), lty=3, col="red")+
#   geom_text(data=plot.labels_p, aes(x=x, y=y, label=labels), size=2.7)+
#   #ylab("% SNPs Bayes Factor > 2.6")+
#   ylab("")+
#   theme_cowplot()+
#   #xlab("Bayenv")+
#   xlab("")+
#   ggtitle("Bayenv")+
#   #scale_y_continuous(limits=c(0,3))+
#   theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(), 
#         axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank(),
#         axis.text=element_text(size=8),
#         axis.title=element_text(size=10),
#         plot.title = element_text(size = 8))
```

## bayes factor at 0.01 for each permutation 
```{r}
bayenv01 = apply(bayes_sortedDF, MARGIN=2, FUN=quantile, probs=0.99)
bayenv01perm = data.frame(top01=bayenv01[1:100])
bayenv01obs = bayenv01[101] # 2.639992
mean(bayenv01obs>bayenv01perm) #0.94

plot.labels_p = data.frame(x=c(2.45,2.45), y=c(3.2,2), labels=c("6% perms.","94% perms."))
# 1 outlier permutation at 10.25292 (omit)
q01_bayenv =
ggplot(subset(bayenv01perm, top01 != max(bayenv01perm$top01)) )+
  geom_jitter(aes(x=1,y=top01), width = 0.5, cex=0.8, alpha=0.2, col="black")+
  geom_segment(aes(x=0.3, y=bayenv01obs, xend = 3, yend=bayenv01obs), lty=3, col="red")+
  geom_text(data=plot.labels_p, aes(x=x, y=y, label=labels), size=2.5)+
  geom_point(aes(x=1,y=bayenv01obs), alpha=0.2, col="red", fill="black", size=2, shape=21)+
  geom_label(aes(x=2.4, y=bayenv01obs, label="observed"), size=2.5, fill="white", col="red")+
  #ylab("% SNPs Bayes Factor > 2.6")+
  ylab("")+
  theme_cowplot()+
  #xlab("Bayenv")+
  xlab("")+
  ggtitle("Bayenv (Bayes factor)")+
  #scale_y_continuous(limits=c(0,3))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        plot.title = element_text(size = 8))
```

## pvalue histogram
```{r}
#save(glm_hist, perm_df2, glm_df, glm_AF_hist, glm2F, file="figure_objects_sig_snps_switch_Jan2018.Rdata")

make_bins = function(x, size){
  x = na.omit(x)
  my_seq = seq(from=0, to=1, by=size)
  my_sum=vector()
  for (i in 1:(length(my_seq)-1) ){
    my_sum[i] = sum(x>=my_seq[i] & x<my_seq[i+1])
  }
  list(my_sum, my_seq)
}
  
mybins = make_bins(reg[,4], 0.001)
trimmed = mybins[[1]][1:(length(mybins[[1]])-1)]

perms = read.table("/Users/hm8/volumes/hm8_network/nescent_melCA/glm_permutations/permutation_prop_by_bin001_perm500.txt", header=TRUE)
perms_trim = perms[,1:(ncol(perms)-1)]
perms_trim2 = t(apply(perms_trim, MARGIN=1, FUN=function(X) X/sum(X)))
perms_trim2_med = apply(perms_trim2, MARGIN=2, FUN=median)
q01 = quantile(reg[,4], probs=0.01)

glm_df = data.frame(pvalue=mybins[[2]][2:(length(mybins[[2]])-1)], prop=trimmed/sum(trimmed))
perm_df = data.frame(pvalue=mybins[[2]][2:(length(mybins[[2]])-1)], prop=t(perms_trim2) )
perm_df2 = melt(perm_df, id="pvalue")
colnames(perm_df2) = c("pvalue","perm","prop")
#save(glm_df_orig,glm2FM_samp_orig, file="/Users/hm8/nescent_melCA/significant_snps/ggplot_glmsig_deltaAF.Rdata")
# load(file="/Users/hm8/nescent_melCA/significant_snps/ggplot_glmsig_deltaAF.Rdata")
# glm_df$set = "Flipped"
# glm_df_orig$set = "Original"
# glm_df2 = rbind(glm_df, glm_df_orig)

Nsnps = nrow(reg) # 774655
which(perm_df[1,2:501]>0.003288156)
which(perm_df[4,2:501]>0.002113722)

#min(which( (1:100)^2 >= 948))
pvalue_subset_inds = c(1:25, round((1:100)^2)[1:31]+26,999)
perm_df_subset = perm_df[ ,c(1,sample(1:500, size=49)+1,96) ]
perm_df2_subset = melt(perm_df_subset[pvalue_subset_inds,], id="pvalue")
colnames(perm_df2_subset) = c("pvalue","perm","prop")


glm_hist = 
  ggplot(perm_df2_subset, aes(pvalue, prop*Nsnps)) +
  geom_line(aes(group=perm), color="black", alpha=0.2) +
  geom_line(data=glm_df, aes(pvalue, prop*Nsnps), color="red", size=0.8, alpha=1) +
  geom_point(data=glm_df, aes(pvalue, prop*Nsnps), color="red", size=1, alpha=1) +
  scale_x_continuous(trans="log10", breaks=c(10^c(-3, -2, -1, 0), expand.grid(sapply(c(1:9), function(x) x*10^c(-3, -2, -1))) [,1]), labels=c(0.001, .01, .1, 1, rep("", length(expand.grid(sapply(c(1:9), function(x) x*10^c(-3, -2, -1)))[,1])) ) ) + 
  geom_hline(yintercept=0.001*Nsnps, lty=2) +
  xlab("Seasonal P-value") + 
  ylab("# SNPs per bin") + 
  geom_vline(xintercept = q01, col="red",lty=3)+
  geom_text(aes(x=c(0.0021), y=c(1000)), label=c("Quant=0.01 \n    P=0.004"), size=2.5, fontface="plain") +
  #theme_light()+
  theme_cowplot()+
  theme(legend.direction="vertical", 
        panel.grid.minor = element_blank(),
        legend.justification=c("right"), 
        legend.position=c(1,0.5), 
        legend.key.size = unit(0.35, "cm"),
        legend.background=element_rect(fill="white", colour="white", linetype="solid", size=.25),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),        
        legend.title.align=.5,
        axis.text=element_text(size=8),
        axis.title=element_text(size=10))                     
```




## AF delta
```{r}
# glm_AF_scatter
#save(glm_df_orig,glm2FM_samp_orig, file="/Users/hm8/nescent_melCA/significant_snps/ggplot_glmsig_deltaAF.Rdata")
load(file="/Users/hm8/stanford/nescent_melCA/significant_snps/ggplot_glmsig_deltaAF.Rdata")

afdelta_plot = 
  ggplot(glm2FM_samp_orig) + 
  geom_point(aes(Smean_fold, abs(meanf_s), color=seas), pch=20, alpha=0.1) +
  geom_smooth(aes(Smean_fold, abs(meanf_s), color=seas)) + 
  #geom_smooth(mapping=aes(Smean_fold, abs(meanf_s), color="seas") ) + 
  scale_color_manual("", values=c("Non-seasonal"="black","Seasonal (Quant=0.01)"="red") ) +
  ylim(c(0,0.15)) + 
  ylab(expression(paste("Spring/fall ",Delta,"AF (abs)"))) +
  xlab("Spring AF") +
  #scale_x_continuous(expand = c(0, 0), limits=c(0.06,0.5))+
  #scale_y_continuous(expand = c(0, 0), limits=c(-0.005,0.15))+
  theme_cowplot()+
  theme(
        legend.direction="vertical",
        legend.justification=c("left"),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        legend.position=c(0.15,0.9),
        legend.key.size = unit(0.35, "cm"),
        legend.background=element_rect(fill=FALSE, colour="white", linetype="solid", size=.25),

        #legend.position = "none",
        
        legend.title.align=0,
        legend.margin=margin(0,0,0,0),
        #      legend.box.just = "left",
        axis.text=element_text(size=8),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),
        axis.title=element_text(size=10),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())  

```


## clinal
```{r}
load("/Users/hm8/stanford/nescent_melCA/clinal/figure_objects_Jan2018.Rdata")
load("/Users/hm8/stanford/nescent_melCA/clinal/results/clinal_uniquepopsPAnoMA_parallelism_vs_controlsDec2017_quant_polymorphic_ext.Rdata")
myquant = subset(df2, pops=="CA")[nrow(subset(df2, pops=="CA")):1,c("quant")][4:24]
myquant = c(rev(10^(-(seq(from=0, to=2, by=0.25)))))
#myquant = seq(from=0, to=1, by=0.01)
all_quantN = all_concordN = vector()
quantseas = quantile(allcoef$seas.p, probs=c(0,myquant) )
quantclin = quantile(allcoef[,6], probs=c(0,myquant) )
for (i in 1:(length(myquant))){
  quantboth = na.omit(allcoef[allcoef$seas.p< quantseas[i+1] & allcoef[,6]<quantclin[i+1] & allcoef$seas.p>=quantseas[i] & allcoef[,6]>=quantclin[i], ])
  all_quantN[i] = nrow(quantboth)
  all_concordN[i] = sum( (quantboth[,3]>=0 & quantboth[,5]>=0) | (quantboth[,3]<0 & quantboth[,5]<0) )
}
all_quant_df = data.frame(quant = myquant, N=all_quantN, Nconcord = all_concordN, Pconcord =all_concordN/all_quantN, dataset="ALL" )

load("/Users/hm8/stanford/nescent_melCA/clinal/results/clinal_uniquepopsPAnoMA_CAparallelism_vs_controlsDec2017_quant_polymorphic_ext.Rdata")
ca_quantN = ca_concordN = vector()
quantseas = quantile(allcoef$seas.p, probs=c(0,myquant) )
quantclin = quantile(allcoef[,6], probs=c(0,myquant) )
for (i in 1:(length(myquant))){
  quantboth = na.omit(allcoef[allcoef$seas.p< quantseas[i+1] & allcoef[,6]<quantclin[i+1] & allcoef$seas.p>=quantseas[i] & allcoef[,6]>=quantclin[i], ])
  ca_quantN[i] = nrow(quantboth)
  ca_concordN[i] = sum( (quantboth[,3]>=0 & quantboth[,5]>=0) | (quantboth[,3]<0 & quantboth[,5]<0) )
}
ca_quant_df = data.frame(quant = myquant, N=ca_quantN, Nconcord = ca_concordN, Pconcord =ca_concordN/ca_quantN, dataset="CA")

load("/Users/hm8/stanford/nescent_melCA/clinal/results/clinal_uniquepopsPAnoMA_EUparallelism_vs_controlsDec2017_quant_polymorphic_ext.Rdata")
eu_quantN = eu_concordN = vector()
quantseas = quantile(allcoef$seas.p, probs=c(0,myquant) )
quantclin = quantile(allcoef[,6], probs=c(0,myquant) )
for (i in 1:(length(myquant))){
  quantboth = na.omit(allcoef[allcoef$seas.p< quantseas[i+1] & allcoef[,6]<quantclin[i+1] & allcoef$seas.p>=quantseas[i] & allcoef[,6]>=quantclin[i], ])
  eu_quantN[i] = nrow(quantboth)
  eu_concordN[i] = sum( (quantboth[,3]>=0 & quantboth[,5]>=0) | (quantboth[,3]<0 & quantboth[,5]<0) )
}
eu_quant_df = data.frame(quant = myquant, N=eu_quantN, Nconcord = eu_concordN, Pconcord =eu_concordN/eu_quantN, dataset="EU" )
df_noncum = rbind(all_quant_df, ca_quant_df, eu_quant_df)

clinalplot = 
  ggplot(data=df2, aes(quant, concord, group=pops) ) +
    scale_x_continuous(trans="log10", 
                     breaks=c(10^c(-2, -1, 0), expand.grid(sapply(c(1:9), function(x) x*10^c(-3, -2, -1))) [,1]), 
                     labels=c(.01, .1, 1, rep("", length(expand.grid(sapply(c(1:9), function(x) x*10^c(-3, -2, -1)))[,1])) ) ) + 
  
  geom_hline(yintercept = 0.5, lty=2) +
  geom_polygon(data=nCA, mapping=aes(x=x, y=y, group=NULL, fill=NULL), fill="purple", alpha=0.8) +
  geom_polygon(data=nEU, mapping=aes(x=x, y=y, group=NULL, fill=NULL), fill="light green", alpha=0.5) +
  geom_line(aes(quant, concord)) + 
  #scale_color_manual(name='', values=c("ALL"="blue","CA"="black","EU"="black") ) +
  geom_point(aes(quant, concord, fill=pops, size=pops), color="black", shape=21) + 
  scale_fill_manual(name='', values=c("ALL"="black","CA"="purple","EU"="light green") ) +
  scale_alpha_manual(name='', values=c("ALL"=1,"CA"=0.7,"EU"=0.2) ) +
  scale_size_manual(name='', values=c("ALL"=2,"CA"=2,"EU"=2) ) +
  ylab("Concordance") + 
  xlab("Seasonal/latitudinal quantile") +
  theme_cowplot()+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.direction="vertical", 
        legend.justification=c("right"), 
        legend.position=c(1,0.25), 
        legend.key.size = unit(0.35, "cm"),
        legend.background=element_rect(fill=FALSE, colour="white", linetype="solid", size=.25),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        legend.title.align=.5,  
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 12)),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10) )
```




## RFM selection estimate heatmap
```{r}
load(file="/Users/hm8/stanford/nescent_melCA/simulated_data/one_script_from_realdata/sim_obs_polymorphic_ggplotJune2019.Rdata")
# sim_obs_polymorphic_ggplot
myPalette <- colorRampPalette(rev(brewer.pal(9, "Blues")))
d1 = head(ss_allN[order(ss_allN$ss),], n=nrow(ss_allN)*0.01)

sim_obs_polymorphic_ggplot = 
  ggplot(ss_allN, aes(s, prop)) + 
  geom_tile(aes(fill = log(ss))) + 
  scale_fill_gradientn("log(SSD)", colors=myPalette(13),na.value = "white") + 
  xlab("Seasonal selection coefficient") + 
  ylab("Proportion of sites") + 
  theme_cowplot()+
  geom_point(data=d1, aes(x=s,y=prop), color="yellow", size=0.5)+
  #scale_x_continuous(expand = c(0, 0))+
  #scale_y_continuous(expand = c(0, 0))+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.direction="vertical", 
        legend.justification=c("right"), 
        #      legend.position=c(1.1,0.5), 
        legend.key.size = unit(0.35, "cm"),
        legend.background=element_rect(fill="white", colour="white", linetype="solid", size=.25),
        legend.text=element_text(size=6),
        legend.title=element_text(size=8),
        legend.title.align=0,
        legend.margin=margin(0,0,0,0),
        #      legend.box.just = "left",
        axis.text=element_text(size=8),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),
        axis.title=element_text(size=10))    

```


### sliding window plot
```{r}
# object: slidindWindow
load( file="/Users/hm8/stanford/nescent_melCA/figures/Alan_figure_objects/AlanFilesApril23/morefiles/slidindWindow_switch_orig.100.5.Rdata")

getGeneWindowLoc <- function(chr="2L", pos=7693727, swDat=slidindWindow) {
  #chr="2L"
  #pos=7693727
  #swDat <- o
  swDat[chr.x==chr][minPos<=pos][maxPos>=pos][which.max(pp)]$windowId
}	

## log10 with circles  
slidindWindow$chr.xF = paste(slidindWindow$chr.x, "F", sep="")
chroms = unique(slidindWindow$chr.x)
chromlim = matrix(nrow=4, ncol=2)
for (i in 1:length(chroms)){
  chromlim[i,1] = min(slidindWindow$minPos[slidindWindow$chr.x==chroms[i]])
  chromlim[i,2] = max(slidindWindow$minPos[slidindWindow$chr.x==chroms[i]])
}
chromlim2 = matrix(c(1,19, 2, 20, 1, 19, 2, 28)*1000000, ncol=2, byrow = T)

seasclust_log10 = 
  ggplot() + 
  geom_line(data=subset(data.frame(slidindWindow), mod=="orig"), aes(x=minPos, y=-log10(p), color=chr.x)) + 
  geom_point(data=subset(data.frame(slidindWindow), mod=="orig" & p.a<=0.05), aes(x=minPos, y=-log10(p)), pch=21, size=0.8) + 
  facet_wrap( ~ chr.x, nrow=1, scales = "free_x") +
  #geom_segment(aes(x=minPos, xend=minPos, y=1, yend=11), data=my_lines, size=.15, linetype="dotted" ) + 
  #geom_segment(aes(x=minPos, xend=minPos, y=-15.16274, yend=11), data=my_lines, size=.15, linetype="dotted" ) + 
  #geom_text(aes(x=minPos, y=13, label=mylabel), data=my_text, size=3) + 		
  scale_color_manual(guide=FALSE, values=c("2L"="red","2R"=hsv(0,0.3),"3L"="red","3R"=hsv(0,0.3), "2LF"="#4292c6","2RF"="#bdd7e7","3LF"="#4292c6","3RF"="#bdd7e7")) + 
  scale_x_continuous(breaks=c(1*10^7,2*10^7), labels=c(expression(paste(1,"*",10^7)),expression(paste(2,"*",10^7))) ) + 
  scale_y_continuous(breaks=c(-10,0,10), labels=c(10,0,10)) + 
  xlab("Genomic position (bp)")+
  ylab("-log10(p-value)")+
  theme_cowplot()+
  theme(panel.border = element_blank(),
        panel.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text=element_text(size=8),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),
        axis.title=element_text(size=10),
        panel.spacing = unit(0, "lines"),
        strip.text.x = element_text(size = 8),
        strip.background = element_rect(fill="lightgrey", colour="black",size=0.5) )
```
  
## my overdist plot
```{r}
#save(clustS, file="/Users/hm8/stanford/nescent_melCA/clustering_seas_SNPs/obs_theo_cont_switch_both_barplot_teal.Rdata")  ### my overdispersion plot
load(file="/Users/hm8/stanford/nescent_melCA/clustering_seas_SNPs/obs_theo_cont_barplot.Rdata")
#
#theme_cowplot(font_size = 14, font_family = "", line_size = 0.5,
              #rel_small = 12/14, rel_tiny = 11/14, rel_large = 16/14)
clust2 = 
  ggplot(clust$data, aes(x=nsig, y=value)) + 
  geom_bar(aes(fill = variable), position =position_dodge(0.8), stat="identity", width=0.7) + 
  scale_fill_manual("", values=c("red","darkgrey","lightgrey")) + 
  coord_cartesian(xlim=c(0,13), ylim=c(1,3500) ) + 
  ylab("Counts") + 
  xlab("# Seasonal (per 100 SNP window)") + 
  scale_y_continuous(trans="log10", breaks=c(10^c(0,1,2,3), expand.grid(sapply(c(1:9), function(x) x*10^c(0,1,2,3))) [,1]), labels=c(1,10,100,1000, rep("", length(expand.grid(sapply(c(1:9), function(x) x*10^c(0,1,2,3)))[,1])) ) ) +
  scale_x_continuous(breaks=0:20-0.25, labels=c(0:20) ) +
  geom_errorbar(aes(ymin=errbar_ymin, ymax=value+2*sdvalue, group=c(variable)), width=0.5,  position =position_dodge(0.8), size=0.2) +
  theme_cowplot()+
  theme(legend.direction="vertical", 
        legend.justification=c("right"), 
        legend.position=c(1,0.5), 
        legend.key.size = unit(0.35, "cm"),
        legend.background=element_rect(fill="white", colour="white", linetype="solid", size=.25),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        legend.title.align=.5,
        axis.text=element_text(size=8),
        axis.title=element_text(size=10)) 
```


## clinal concordance by inversions
```{r}
concordDF = read.table("/Users/hm8/stanford/nescent_melCA/clinal/inversions/concordDF_Jan2021.txt", header=T, stringsAsFactors = F, sep="\t")
concordDF$class = factor(concordDF$class, levels=c( "all", "bkpts", "interior", "exterior"))

concord_inv = 
  ggplot(subset(concordDF, jointquantile==0.05 & !(inv %in% c("In(3R)K",    "In(3R)Mo",    "In(3R)P")) ), aes(x=chrom, weight=concord, ymin=concord-1.96*se, ymax=concord+1.96*se, fill=class)) +
    geom_bar(position=position_dodge(), aes(y=concord), stat="identity") +
    geom_errorbar(position=position_dodge(width=0.9), colour="grey", width=0.5) +
    geom_hline(yintercept=0.5, linetype="dashed")+
    geom_text    (position=position_dodge(width=0.9), aes(y=0.02, label=pvaluelabel), size=6)+
    scale_fill_brewer("Region", labels=c("all","bkpts.","inside","outside"), palette = "Set2")+
    theme_cowplot()+
    ylab("Concordance")+
    xlab("Chromosome")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 12)),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10))
```

## seasonal enrichment by inversions
```{r}
chr_inv = read.table(file="/Users/hm8/stanford/nescent_melCA/glm_permutations/chr_inv_enrichment_pvalues_Jan2021.txt", header=T, stringsAsFactors = F, sep="\t")
chr_inv$class = factor(chr_inv$class, levels = c( "all", "bkpts", "interior", "exterior") )
enrich_inv = 
  ggplot(subset(chr_inv, pvalue==0.003894319 & !(inv %in% c("In(3R)K",    "In(3R)Mo",    "In(3R)P")) ), aes(x=chrom, weight=median_enrich, ymin=lower95_enrich, ymax=upper95_enrich, fill=class)) +
  geom_bar      (position=position_dodge(), aes(y=median_enrich), stat="identity") +
  geom_errorbar (position=position_dodge(width=0.9), colour="grey", width=0.5) +
  geom_text    (position=position_dodge(width=0.9), aes(y=0.05, label=sig_lower90), size=6)+
  #geom_text    (position=position_dodge(width=0.9), aes(y=median_enrich+0.05, label=sig_lower90), size=8)+
  geom_hline(yintercept=1, linetype="dashed")+
  scale_fill_brewer("Region", labels=c("all","bkpts.","inside","outside"), palette = "Set2")+
  theme_cowplot()+
  ylab("Seasonal enrichment")+ # (# SNPs obs/perm)
  xlab("Chromosome")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
        legend.text=element_text(size=8),
        legend.title=element_text(size=10),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 12)),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10))
```


## save/load individual figures
```{r}
#save(glm_hist,q01_enrich, q01_enrich_bayenv,clust2, q01_enrich_rfm, seasclust_log10,clinalplot, afdelta_plot, sim_obs_polymorphic_ggplot, file="Fig2_individual_objects.Rdata")
#load(file="Fig2_individual_objects.Rdata")
# Nsnps=774655
```


## all plots, Jan2021 with inversions
```{r}
toprow2 = plot_grid(glm_hist, NULL, q01_pvalue + theme(plot.margin = unit(c(5.5, 0, 20, 4), "points")), q01_bayenv + theme(plot.margin = unit(c(5.5, 0, 20, 0), "points")), q01_rfm_x + theme(plot.margin = unit(c(5.5, 4, 20, 0), "points")),
                          labels = c('A', "", 'B'),
                          nrow=1, vjust=1.5, scale = c(1,1,1,1,1), rel_widths = c(0.45, 0.05, c(0.2, 0.175, 0.195)/1.14) )

middlerow2 = plot_grid(afdelta_plot, NULL, enrich_inv,
                        labels = c("C", "","D"),
                          nrow=1, vjust=1.5, scale = 1, rel_widths = c(0.45, 0.05, 0.5) )

bottomrow2 = plot_grid(clinalplot, NULL, concord_inv,
                          labels = c("E","","F"),
                          nrow=1, vjust=1.5, scale = 1, rel_widths = c(0.45, 0.05, 0.5) )
multiPlot =
  plot_grid(toprow2,NULL, middlerow2,NULL, bottomrow2, nrow = 5, vjust=1.5, rel_heights = c(1, 0.2, 1, 0.2, 1))

save_plot(multiPlot, file="Fig2_6panel_3nrow_teststat_Jan2021.pdf", base_height=11, base_width = 11)
#save_plot(multiPlot, file="Fig2_6panel_3nrow_teststat_Jan2021.png", base_height=11, base_width = 11)
#save(glm_hist,q01_enrich, q01_enrich_bayenv,clust2, seasclust_log10,clinalplot, afdelta_plot, sim_obs_polymorphic_ggplot, file="Fig2_individual_objects.Rdata")
```
